<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>极简阅读器 Pro - 实时版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        :root { --sat: env(safe-area-inset-top); --sab: env(safe-area-inset-bottom); }
        body { background-color: #f8fafc; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        .safe-top { padding-top: var(--sat); }
        .safe-bottom { padding-bottom: var(--sab); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .content-area img { max-width: 100%; height: auto; border-radius: 0.5rem; margin: 1rem 0; }
        .content-area a { color: #2563eb; text-decoration: underline; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // 图标组件
        const Icon = ({ name, className = "" }) => {
            const icons = {
                rss: "M4 11a9 9 0 0 1 9 9M4 4a16 16 0 0 1 16 16M6 19a1 1 0 1 1-1-1 1 1 0 0 1 1 1z",
                plus: "M12 5v14M5 12h14",
                back: "M15 18l-6-6 6-6",
                delete: "M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2",
                loading: "M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"
            };
            return (
                <svg className={className} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <path d={icons[name]} />
                </svg>
            );
        };

        function App() {
            const [feeds, setFeeds] = useState(() => {
                const saved = localStorage.getItem('rss_feeds');
                return saved ? JSON.parse(saved) : [
                    { name: '少数派', url: 'https://sspai.com/feed' },
                    { name: '36氪', url: 'https://www.36kr.com/feed' }
                ];
            });
            
            const [view, setView] = useState('list'); // list, add, detail
            const [currentFeed, setCurrentFeed] = useState(null);
            const [articles, setArticles] = useState([]);
            const [selectedArticle, setSelectedArticle] = useState(null);
            const [loading, setLoading] = useState(false);
            const [newUrl, setNewUrl] = useState('');
            const [error, setError] = useState('');

            // 持久化存储订阅源
            useEffect(() => {
                localStorage.setItem('rss_feeds', JSON.stringify(feeds));
            }, [feeds]);

            // 使用 RSS2JSON API 绕过跨域限制解析 RSS
            const fetchArticles = async (url) => {
                setLoading(true);
                setError('');
                try {
                    const res = await fetch(`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(url)}`);
                    const data = await res.json();
                    if (data.status === 'ok') {
                        setArticles(data.items);
                        setView('feed-detail');
                    } else {
                        throw new Error('无法解析该订阅源');
                    }
                } catch (err) {
                    setError('加载失败，请检查链接是否有效或网络连接。');
                } finally {
                    setLoading(false);
                }
            };

            const addFeed = async () => {
                if (!newUrl) return;
                setLoading(true);
                try {
                    const res = await fetch(`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(newUrl)}`);
                    const data = await res.json();
                    if (data.status === 'ok') {
                        const newFeed = { name: data.feed.title, url: newUrl };
                        setFeeds([...feeds, newFeed]);
                        setNewUrl('');
                        setView('list');
                    } else {
                        setError('无效的 RSS 地址');
                    }
                } catch (err) {
                    setError('添加失败');
                } finally {
                    setLoading(false);
                }
            };

            const deleteFeed = (url) => {
                setFeeds(feeds.filter(f => f.url !== url));
            };

            // 渲染主列表
            if (view === 'list') {
                return (
                    <div className="min-h-screen flex flex-col">
                        <header className="safe-top bg-white border-b px-6 py-4 flex justify-between items-center sticky top-0 z-20">
                            <h1 className="text-xl font-bold text-slate-900">我的订阅</h1>
                            <button onClick={() => setView('add')} className="p-2 bg-blue-50 text-blue-600 rounded-full active:scale-90 transition-transform">
                                <Icon name="plus" />
                            </button>
                        </header>
                        <main className="p-4 space-y-3">
                            {feeds.map(feed => (
                                <div key={feed.url} className="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex justify-between items-center active:bg-slate-50" 
                                     onClick={() => { setCurrentFeed(feed); fetchArticles(feed.url); }}>
                                    <div className="flex-1">
                                        <div className="font-bold text-slate-800">{feed.name}</div>
                                        <div className="text-xs text-slate-400 truncate max-w-[200px]">{feed.url}</div>
                                    </div>
                                    <button onClick={(e) => { e.stopPropagation(); deleteFeed(feed.url); }} className="p-2 text-slate-300 hover:text-red-500">
                                        <Icon name="delete" className="w-5 h-5" />
                                    </button>
                                </div>
                            ))}
                        </main>
                        {loading && (
                            <div className="fixed inset-0 bg-white/50 backdrop-blur-sm flex items-center justify-center z-50">
                                <Icon name="loading" className="animate-spin text-blue-600 w-10 h-10" />
                            </div>
                        )}
                    </div>
                );
            }

            // 渲染添加页面
            if (view === 'add') {
                return (
                    <div className="min-h-screen bg-white">
                        <header className="safe-top p-4 flex items-center border-b">
                            <button onClick={() => setView('list')} className="p-2"><Icon name="back" /></button>
                            <span className="ml-2 font-bold">添加订阅</span>
                        </header>
                        <div className="p-6">
                            <input 
                                type="url" 
                                placeholder="输入 RSS 地址 (http...)" 
                                className="w-full p-4 bg-slate-100 rounded-2xl outline-none focus:ring-2 ring-blue-500 transition-all"
                                value={newUrl}
                                onChange={(e) => setNewUrl(e.target.value)}
                            />
                            {error && <p className="text-red-500 text-sm mt-2 ml-2">{error}</p>}
                            <button 
                                onClick={addFeed}
                                disabled={loading}
                                className="w-full mt-6 py-4 bg-blue-600 text-white rounded-2xl font-bold shadow-lg shadow-blue-100 disabled:opacity-50"
                            >
                                {loading ? '验证中...' : '确认添加'}
                            </button>
                            <div className="mt-8">
                                <h3 className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4">推荐</h3>
                                <div className="space-y-2 text-sm text-blue-600">
                                    <div className="cursor-pointer" onClick={() => setNewUrl('https://www.zhihu.com/rss')}>知乎精选: zhihu.com/rss</div>
                                    <div className="cursor-pointer" onClick={() => setNewUrl('https://36kr.com/feed')}>36氪: 36kr.com/feed</div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            // 渲染文章列表
            if (view === 'feed-detail') {
                return (
                    <div className="min-h-screen bg-slate-50">
                        <header className="safe-top bg-white border-b px-4 py-3 flex items-center sticky top-0 z-20">
                            <button onClick={() => setView('list')} className="p-2"><Icon name="back" /></button>
                            <h2 className="ml-2 font-bold truncate text-slate-800">{currentFeed?.name}</h2>
                        </header>
                        <div className="p-4 space-y-4">
                            {articles.map((item, idx) => (
                                <div key={idx} className="bg-white p-5 rounded-3xl shadow-sm border border-slate-100 active:scale-[0.98] transition-transform"
                                     onClick={() => { setSelectedArticle(item); setView('article-content'); }}>
                                    <h3 className="font-bold text-slate-800 mb-2 leading-snug">{item.title}</h3>
                                    <div className="text-xs text-slate-400">{new Date(item.pubDate).toLocaleDateString()} • {item.author || '未知作者'}</div>
                                </div>
                            ))}
                        </div>
                    </div>
                );
            }

            // 渲染文章正文
            if (view === 'article-content' && selectedArticle) {
                return (
                    <div className="min-h-screen bg-white">
                        <header className="safe-top bg-white/80 backdrop-blur-md border-b px-4 py-3 flex items-center sticky top-0 z-20">
                            <button onClick={() => setView('feed-detail')} className="p-2"><Icon name="back" /></button>
                            <span className="ml-2 text-sm font-medium text-slate-500 truncate">{selectedArticle.title}</span>
                        </header>
                        <article className="p-6 max-w-2xl mx-auto">
                            <h1 className="text-2xl font-black text-slate-900 mb-4">{selectedArticle.title}</h1>
                            <div className="flex items-center text-xs text-slate-400 mb-8 pb-4 border-b">
                                <span>{selectedArticle.pubDate}</span>
                            </div>
                            <div 
                                className="content-area prose prose-slate text-slate-700 leading-relaxed"
                                dangerouslySetInnerHTML={{ __html: selectedArticle.content }}
                            />
                        </article>
                        <div className="safe-bottom h-10"></div>
                    </div>
                );
            }
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
